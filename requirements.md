# 要件定義書 - Dify音声再生プレイヤーシステム

## 1. プロジェクト概要

### 1.1 目的
特許制度講演の音声ファイルとDifyチャットフローを連携させたインタラクティブな学習システムを構築する。ユーザーは講演内容に関する質問をチャットで投げかけ、AI応答とともに関連する音声箇所を自動で再生・ループできる学習支援ツールを提供する。

### 1.2 対象ユーザー
- 特許制度を学習する学生・受講生
- 特許事務所・企業の新人研修担当者
- 特許制度の復習を行う実務者

## 2. ユーザーストーリー

### 2.1 メインユーザーストーリー
**As a** 特許制度の学習者  
**I want to** 講演音声を聞きながらチャットで質問し、関連箇所を即座に確認したい  
**So that** 効率的かつインタラクティブに学習を進められる

### 2.2 詳細ユーザーストーリー

#### 音声再生機能
- **As a** ユーザー **I want to** 講演音声ファイルを波形表示で視覚的に確認しながら再生したい **So that** 内容の全体像を把握できる
- **As a** ユーザー **I want to** 音声の任意の位置にシークできる **So that** 聞きたい箇所にすぐにアクセスできる

#### チャット機能
- **As a** ユーザー **I want to** 講演内容について自然言語で質問したい **So that** 疑問をすぐに解消できる
- **As a** ユーザー **I want to** AI応答とともにタイムスタンプ情報を取得したい **So that** 関連する音声箇所を特定できる

#### 自動頭出し・ループ機能
- **As a** ユーザー **I want to** AI応答で示されたタイムスタンプ箇所に自動で移動したい **So that** すぐに関連音声を確認できる
- **As a** ユーザー **I want to** 指定区間をループ再生したい **So that** 重要な箇所を繰り返し学習できる

## 3. 機能要件

### 3.1 コア機能

#### 3.1.1 音声ファイル管理
- **REQ-001**: 音声ファイル（mp3, wav, mp4, m4a）のアップロード機能
- **REQ-002**: 音声ファイルのメタデータ管理（タイトル、長さ、トランスクリプト）
- **REQ-003**: 音声ファイルの一覧表示・検索機能

#### 3.1.2 音声再生機能
- **REQ-004**: WaveSurfer.jsによる波形表示機能
- **REQ-005**: 再生・停止・シークバー操作機能
- **REQ-006**: 音量調整機能
- **REQ-007**: 再生速度調整機能（0.5x, 1x, 1.5x, 2x）

#### 3.1.3 Difyチャット連携機能
- **REQ-008**: Dify Chat APIとのリアルタイム通信機能
- **REQ-009**: ストリーミングモードでのチャット応答受信
- **REQ-010**: 会話履歴の保存・管理機能
- **REQ-011**: 複数セッションの管理機能

#### 3.1.4 タイムスタンプ解析機能
- **REQ-012**: AI応答からの `[分:秒-分:秒]` 形式タイムスタンプ自動抽出
- **REQ-013**: タイムスタンプの秒単位変換機能
- **REQ-014**: 複数タイムスタンプの処理対応

#### 3.1.5 自動頭出し・ループ機能
- **REQ-015**: タイムスタンプ位置への自動シーク機能
- **REQ-016**: 指定区間のループ再生機能
- **REQ-017**: ループ回数の設定機能
- **REQ-018**: ループ開始・終了位置の手動調整機能

### 3.2 サポート機能

#### 3.2.1 ユーザーインターフェース
- **REQ-019**: レスポンシブデザイン対応
- **REQ-020**: キーボードショートカット対応
- **REQ-021**: 直感的な操作フロー
- **REQ-022**: リアルタイム状態表示

#### 3.2.2 データ管理
- **REQ-023**: チャット履歴のエクスポート機能
- **REQ-024**: 学習進捗の記録機能
- **REQ-025**: ブックマーク機能

## 4. 非機能要件

### 4.1 パフォーマンス要件
- **NFR-001**: 音声ファイル読み込み時間: 5秒以内（100MB以下のファイル）
- **NFR-002**: チャット応答時間: 3秒以内（95%の場合）
- **NFR-003**: タイムスタンプ解析時間: 1秒以内
- **NFR-004**: 同時接続ユーザー数: 最大50名

### 4.2 可用性要件
- **NFR-005**: システム稼働率: 99%以上
- **NFR-006**: エラー復旧時間: 5分以内
- **NFR-007**: 定期メンテナンス時間: 月1回、30分以内

### 4.3 セキュリティ要件
- **NFR-008**: APIキーの安全な管理（環境変数使用）
- **NFR-009**: ファイルアップロード時の形式・サイズ制限
- **NFR-010**: CSRF保護の実装
- **NFR-011**: 入力データの適切な検証・サニタイズ

### 4.4 使いやすさ要件
- **NFR-012**: 初回利用時の操作習得時間: 5分以内
- **NFR-013**: 主要操作の完了ステップ数: 3ステップ以内
- **NFR-014**: エラーメッセージの日本語対応

### 4.5 保守性要件
- **NFR-015**: コードカバレッジ: 80%以上
- **NFR-016**: 機能追加時の既存機能への影響: 最小限
- **NFR-017**: ログ出力とモニタリング機能

## 5. システム要件

### 5.1 開発環境要件
- **SYS-001**: 開発OS: macOS（MacBookPro対応）
- **SYS-002**: Python: 3.9以上
- **SYS-003**: Python仮想環境: venv使用
- **SYS-004**: バージョン管理: Git + GitHub

### 5.2 チーム開発要件
- **SYS-005**: 依存関係管理: requirements.txt
- **SYS-006**: 環境変数管理: .envファイル
- **SYS-007**: Git除外設定: .gitignore（venv/, .env, __pycache__/等）
- **SYS-008**: 環境設定テンプレート: .env.example提供
- **SYS-009**: セットアップドキュメント: README.md

### 5.3 技術要件
- **SYS-010**: バックエンド: Django 4.x + Django REST Framework
- **SYS-011**: フロントエンド: HTML5 + JavaScript + WaveSurfer.js
- **SYS-012**: データベース: SQLite（開発） / PostgreSQL（本番）
- **SYS-013**: 外部API: Dify Chat API (https://djartipy.com/v1)

### 5.4 ファイル制限要件
- **SYS-014**: 音声ファイル最大サイズ: 100MB
- **SYS-015**: 対応音声形式: mp3, wav, mp4, m4a
- **SYS-016**: 同時アップロードファイル数: 1ファイル

## 6. 外部インターフェース要件

### 6.1 Dify API連携要件
- **INT-001**: ベースURL: https://djartipy.com/v1
- **INT-002**: 認証方式: Bearer Token
- **INT-003**: 主要エンドポイント:
  - POST /chat-messages（チャット送信）
  - GET /messages（履歴取得）
  - GET /conversations（会話一覧）
- **INT-004**: ストリーミング応答対応
- **INT-005**: タイムスタンプ形式: [分:秒-分:秒]

### 6.2 音声処理要件
- **INT-006**: 音声解析ライブラリ: librosa, pydub
- **INT-007**: 波形表示: WaveSurfer.js
- **INT-008**: ブラウザ音声再生: Web Audio API

## 7. 品質要件

### 7.1 テスト要件
- **QUA-001**: 単体テスト: DifyAPIクライアント、タイムスタンプ抽出機能
- **QUA-002**: 統合テスト: API連携、音声再生連動
- **QUA-003**: E2Eテスト: ユーザーシナリオベース
- **QUA-004**: 音声ファイル処理テスト

### 7.2 ドキュメント要件
- **QUA-005**: コード内ドキュメント: docstring
- **QUA-006**: API仕様書: OpenAPI形式
- **QUA-007**: ユーザーマニュアル
- **QUA-008**: 開発者ガイド

## 8. 制約事項

### 8.1 技術制約
- **CON-001**: DifyAPIレート制限の遵守
- **CON-002**: ブラウザ互換性: Chrome, Firefox, Safari（最新版）
- **CON-003**: JavaScript有効環境での動作

### 8.2 運用制約
- **CON-004**: 音声ファイルはローカルストレージに保存
- **CON-005**: APIキーは開発者個別管理
- **CON-006**: 講演内容の著作権遵守

## 9. 成功基準

### 9.1 機能成功基準
- 音声再生とチャット機能の正常動作
- タイムスタンプ自動抽出精度: 95%以上
- 自動頭出し機能の正確性: 99%以上

### 9.2 ユーザビリティ成功基準
- ユーザー操作習得時間: 目標5分以内
- システム応答満足度: 4/5以上（ユーザー評価）

### 9.3 技術成功基準
- 全機能要件の実装完了
- テストカバレッジ: 80%以上達成
- チーム開発環境の円滑な構築・運用